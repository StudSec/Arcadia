x-deployment: &deployment
  replicas: 1
  endpoint_mode: dnsrr
  resources:
    limits:
      memory: 2048M
    reservations:
      memory: 128M
  placement:
    constraints:
      - node.labels.type == ctf

services:
  ctfd:
    image: ctfd/ctfd:3.8.1
    user: root
    restart: always
    environment:
      - UPLOAD_FOLDER=/var/uploads
      - DATABASE_URL=mysql+pymysql://ctfd:ctfd@db/ctfd
      - REDIS_URL=redis://cache:6379
      - WORKERS=7
      - SECRET_KEY=$SECRET_KEY
      - LOG_FOLDER=/var/log/CTFd
      - ACCESS_LOG=-
      - ERROR_LOG=-
      - REVERSE_PROXY=true
      - PRESET_ADMIN_USER=admin
      - PRESET_ADMIN_EMAIL=changeme@example.com
      - PRESET_ADMIN_PASSWORD=$ADMIN_PASS
      - PRESET_ADMIN_TOKEN=$ADMIN_TOKEN
    volumes:
      - /opt/ctfd/CTFd/data/logs:/var/log/CTFd
      - /opt/ctfd/CTFd/data/uploads:/var/uploads
      - /opt/ctfd/CTFd/plugins:/opt/CTFd/CTFd/plugins
    depends_on:
      - db
      - cache
    healthcheck:
      test: python3 -c 'import requests; requests.get("http://localhost:8000")'
      interval: 30s
      retries: 3
      timeout: 15s
    networks:
      internal:
      traefik-ctf:
    deploy:
      <<: *deployment
    labels:
      - "traefik.enable=true"
      - "traefik.docker.lbswarm=true"
      - "traefik.docker.network=traefik-ctf"
      # https entrypoint
      - "traefik.http.routers.ctf-https.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.ctf-https.entrypoints=https"
      - "traefik.http.routers.ctf-https.tls=true"
      # explicitly use le as certresolver
      - "traefik.http.routers.ctf-https.tls.certresolver=letsencrypt"
      # Needed for ctfd behind reverse proxy
      - "traefik.http.routers.ctf-https.middlewares=forward-proto@file"
      - "traefik.http.routers.ctf-https.service=ctfHttpsService"
      - "traefik.http.services.ctfHttpsService.loadbalancer.server.port=8000"

  db:
    image: mariadb:10.11
    restart: always
    environment:
      - MARIADB_ROOT_PASSWORD=ctfd
      - MARIADB_USER=ctfd
      - MARIADB_PASSWORD=ctfd
      - MARIADB_DATABASE=ctfd
      - MARIADB_AUTO_UPGRADE=1
    volumes:
      - /opt/ctfd/CTFd/.data/mysql:/var/lib/mysql
    networks:
      internal:
    # This command is required to set important mariadb defaults
    command:
      [
        mysqld,
        --character-set-server=utf8mb4,
        --collation-server=utf8mb4_unicode_ci,
        --wait_timeout=28800,
        --log-warnings=0,
      ]
    deploy:
      <<: *deployment

  cache:
    image: redis:4
    restart: always
    volumes:
      - /opt/ctfd/CTFd/.data/redis:/data
    networks:
      internal:
    deploy:
      <<: *deployment

  ctfd-setup:
    image: ctferio/ctfd-setup:v1.7.1
    environment:
      URL: http://ctfd:8000
      FILE: /opt/ctfd-setup/.ctfd.yaml
      DIRECTORY: /opt/ctfd-setup
    env_file:
      - /opt/ctfd/ctfd-setup/.env
    volumes:
      - /opt/ctfd/ctfd-setup:/opt/ctfd-setup
    networks:
      internal:
    depends_on:
      - ctfd
    deploy:
      <<: *deployment
      restart_policy:
        condition: on-failure

networks:
  traefik-ctf:
    external: true
  internal:
    internal: true
